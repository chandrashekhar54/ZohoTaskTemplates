name: Automated Zoho Task Creator

on:
  push:
    branches:
      - main
    paths:
      - '**.xlsx'
      
jobs:
  run-task-automation:
    runs-on: self-hosted

    steps:

      - name: Checkout ZohoTaskTemplates repo
        uses: actions/checkout@v2
        with:
          fetch-depth: 0


      - name: Identify changed Excel files
        shell: powershell
        run: |
          git diff --name-only HEAD^ HEAD > changed_files.txt
          Get-Content changed_files.txt

      - name: Set file path
        id: setpath
        shell: powershell
        run: |
          $file = Select-String -Path changed_files.txt -Pattern '\.xlsx$' | Select-Object -First 1
          if ($file -ne $null) {
            echo "::set-output name=filepath::$($file.Line)"
          } else {
            echo "No .xlsx file changed"
          }

      - name: Checkout GRL-Zoho-Insights (TaskCreate branch)
        uses: actions/checkout@v2
        with:
          repository: chandrashekhar54/GRL-Zoho-Insights
          ref: TaskCreate
          token: ${{ secrets.REPO_TOKEN }}


      - name: Run C# application with Excel file
        shell: powershell
        run: |
          cd GRL-Zoho-Insights/GRL-Zoho-Insights
          dotnet build
          dotnet run -- "../../${{ steps.setpath.outputs.filepath }}"
