name: Automated Zoho Task creater

on:
  push: # Trigger the workflow on push events
    branches:
      - main # Adjust this based on your branch
    paths:
      - '**.xlsx' # Detect any Excel file changes in the repository
      
jobs:
  run-task-automation:
    runs-on: self-hosted
    steps:
      # 1. Checkout ZohoTaskTemplates repo
      - name: Checkout ZohoTaskTemplates repo
        uses: actions/checkout@v2
        with:
          fetch-depth: 0  # Fetch full commit history

      # 2. Identify the changed Excel file
      - name: Identify changed Excel files
        run: |
          git diff --name-only HEAD^ HEAD > changed_files.txt
          cat changed_files.txt
          
      - name: Set file path
        id: setpath
        run: |
          $FILE = (Get-Content changed_files.txt | Select-String -Pattern '\.xlsx$' | Select-Object -First 1).Line
          Write-Output "::set-output name=filepath::$FILE"

      # 3. Checkout the GRL-Zoho-Insights repo on the TaskCreate branch
      - name: Checkout GRL-Zoho-Insights (TaskCreate branch)
        uses: actions/checkout@v2
        with:
          repository: chandrashekhar54/GRL-Zoho-Insights
          ref: TaskCreate
          token: ${{ secrets.REPO_TOKEN }}
          fetch-depth: 1  # Limit history to the latest commit
          submodules: false

      - name: Cache .NET packages
        uses: actions/cache@v2
        with:
         path: ~/.nuget/packages
         key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
         restore-keys: |
           ${{ runner.os }}-nuget-   

      # 4. Navigate to the folder with .csproj and build the application
      - name: Run C# application with Excel file
        run: |
          dotnet build
          dotnet run -- "../../${{ steps.setpath.outputs.filepath }}"

      
     
