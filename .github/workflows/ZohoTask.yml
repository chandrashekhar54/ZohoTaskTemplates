name: Automated Zoho Task Creator

on:
  push:
    branches:
      - main
    paths:
      - '**.xlsx'

jobs:
  run-task-automation:
    runs-on: self-hosted

    steps:
      # 1. Checkout ZohoTaskTemplates repo
      - name: Checkout ZohoTaskTemplates repo
        uses: actions/checkout@v3

      # 2. Identify the changed Excel file
      - name: Identify changed Excel files
        run: |
          git diff --name-only HEAD^ HEAD > changed_files.txt
          cat changed_files.txt
          
      - name: Set file path
        id: setpath
        run: |
          $FILE = (Get-Content changed_files.txt | Select-String -Pattern '\.xlsx$' | Select-Object -First 1).Line
          Write-Output "::set-output name=filepath::$FILE"

      # 3. Checkout GRL-Zoho-Insights repo on the TaskCreate branch
      - name: Checkout GRL-Zoho-Insights (TaskCreate branch)
        uses: actions/checkout@v3
        with:
          repository: chandrashekhar54/GRL-Zoho-Insights
          ref: TaskCreate
          fetch-depth: 1

      # 4. Build the Zoho Automation Tool
      - name: Build Zoho Automation Tool
        run: dotnet build GRL-Zoho-Insights/GRL-Zoho-Insights.csproj --configuration Release

      # 5. Run the Zoho Automation Tool with the Excel file
      - name: Run Zoho Automation Tool
        run: dotnet run --project GRL-Zoho-Insights/GRL-Zoho-Insights.csproj -- "../../${{ steps.setpath.outputs.filepath }}"
